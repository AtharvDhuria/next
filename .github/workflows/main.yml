name: Deploy to ECR

on:
  push:
    branches: [ sujal-main ]

jobs:
  build:
    name: Build Image
    runs-on: ubuntu-latest
    environment: AWS

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Read and verify secrets (SAFE DEBUG)
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      run: |
        echo "ðŸ” DEBUG: Checking presence of AWS secrets (values are masked in logs)"

        # Print lengths to confirm values exist without revealing secrets
        echo -n "AWS_ACCESS_KEY_ID length: "
        echo -n "$AWS_ACCESS_KEY_ID" | wc -c

        echo -n "AWS_SECRET_ACCESS_KEY length: "
        echo -n "$AWS_SECRET_ACCESS_KEY" | wc -c

        echo -n "AWS_ACCOUNT_ID: "
        echo "$AWS_ACCOUNT_ID"

        # Print small prefixes only (do NOT print full secrets)
        echo "AWS_ACCESS_KEY_ID prefix: ${AWS_ACCESS_KEY_ID:0:4}***"
        echo "AWS_SECRET_ACCESS_KEY prefix: ${AWS_SECRET_ACCESS_KEY:0:4}***"

        if [ -z \"$AWS_ACCESS_KEY_ID\" ] || [ -z \"$AWS_SECRET_ACCESS_KEY\" ]; then
          echo \"ERROR: One or more required secrets are empty. Verify repository secrets in Settings -> Secrets and variables -> Actions\"
          exit 1
        fi

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-south-1

    - name: Verify AWS credentials
      run: |
        aws sts get-caller-identity
        echo "AWS credentials configured successfully"

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      with:
        registries: ${{ secrets.AWS_ACCOUNT_ID }}

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: test_ml_demo
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Build the Docker image
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .

        # Push the images
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
